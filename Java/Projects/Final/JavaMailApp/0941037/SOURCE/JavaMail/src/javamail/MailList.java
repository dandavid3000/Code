/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * MailList.java
 *
 * Created on Oct 29, 2010, 8:26:17 PM
 */

package javamail;

import java.io.*;
import java.net.Socket;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import javax.swing.JWindow;
import javax.swing.table.TableColumn;

/**
 *
 * @author Dan
 */
public class MailList extends javax.swing.JFrame {

    /** Creates new form MailList */
    public MailList() {
        initComponents();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
//     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel4 = new javax.swing.JLabel();
        jLabel1 = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        tbMailList = new javax.swing.JTable();
        jScrollPane2 = new javax.swing.JScrollPane();
        txtNoiDung = new javax.swing.JTextArea();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jScrollPane3 = new javax.swing.JScrollPane();
        tbOldMail = new javax.swing.JTable();
        jToggleButton1 = new javax.swing.JToggleButton();
        txtSoThuSV = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Liệt kê thư và xem nội dung");
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowActivated(java.awt.event.WindowEvent evt) {
                formWindowActivated(evt);
            }
        });

        jLabel4.setFont(new java.awt.Font("Tahoma", 1, 36));
        jLabel4.setForeground(new java.awt.Color(0, 204, 51));
        jLabel4.setText("Đọc thư");

        jLabel1.setFont(new java.awt.Font("Tahoma", 0, 14));
        jLabel1.setText("------------ Nội dung thư ----------------------------------");

        tbMailList.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null}
            },
            new String [] {
                "Đến từ", "Chủ đề", "Ngày gửi"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        tbMailList.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                tbMailListMouseClicked(evt);
            }
        });
        jScrollPane1.setViewportView(tbMailList);
        tbMailList.getColumnModel().getColumn(0).setPreferredWidth(150);
        tbMailList.getColumnModel().getColumn(0).setMaxWidth(150);
        tbMailList.getColumnModel().getColumn(2).setPreferredWidth(120);
        tbMailList.getColumnModel().getColumn(2).setMaxWidth(120);

        txtNoiDung.setColumns(20);
        txtNoiDung.setRows(5);
        jScrollPane2.setViewportView(txtNoiDung);

        jLabel2.setText("-----------------Thư mới --------------");

        jLabel3.setText("-----------------Thư cũ --------------");

        tbOldMail.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null}
            },
            new String [] {
                "Đến từ", "Chủ đề", "Ngày gửi"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        tbOldMail.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                tbOldMailMouseClicked(evt);
            }
        });
        jScrollPane3.setViewportView(tbOldMail);
        tbOldMail.getColumnModel().getColumn(0).setPreferredWidth(150);
        tbOldMail.getColumnModel().getColumn(0).setMaxWidth(150);
        tbOldMail.getColumnModel().getColumn(2).setPreferredWidth(120);
        tbOldMail.getColumnModel().getColumn(2).setMaxWidth(120);

        jToggleButton1.setFont(new java.awt.Font("Tahoma", 1, 18));
        jToggleButton1.setForeground(new java.awt.Color(255, 0, 51));
        jToggleButton1.setText("Xóa Thư");
        jToggleButton1.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                jToggleButton1MouseClicked(evt);
            }
        });
        jToggleButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jToggleButton1ActionPerformed(evt);
            }
        });

        txtSoThuSV.setText("jLabel5");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(53, 53, 53)
                .addComponent(jLabel3)
                .addContainerGap(410, Short.MAX_VALUE))
            .addGroup(layout.createSequentialGroup()
                .addGap(51, 51, 51)
                .addComponent(jLabel2)
                .addContainerGap(407, Short.MAX_VALUE))
            .addGroup(layout.createSequentialGroup()
                .addGap(21, 21, 21)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(10, 10, 10)
                        .addComponent(jLabel1))
                    .addComponent(jScrollPane3)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 584, Short.MAX_VALUE)
                    .addComponent(jScrollPane2))
                .addContainerGap())
            .addGroup(layout.createSequentialGroup()
                .addGap(103, 103, 103)
                .addComponent(txtSoThuSV)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 270, Short.MAX_VALUE)
                .addComponent(jToggleButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 122, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(94, 94, 94))
            .addGroup(layout.createSequentialGroup()
                .addGap(232, 232, 232)
                .addComponent(jLabel4)
                .addContainerGap(247, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel4)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel2)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 84, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(jLabel3)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 89, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel1)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane2, javax.swing.GroupLayout.DEFAULT_SIZE, 274, Short.MAX_VALUE)
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(txtSoThuSV)
                    .addComponent(jToggleButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 44, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void tbMailListMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tbMailListMouseClicked
        // TODO add your handling code here:
        String temp ="";
        int y =0;

        while(y<ReceiveMail.nMail)
        {
            String str = Login.NormalUser+"Thu"+y+".txt";
            File f = new File(str);
            if(f.exists())
                temp = temp +" "+ str;
            y++;
        }

        int i = tbMailList.getSelectedRow();
         String []temp1= temp.split(" ");
        if(i<temp1.length)
        {

            String noidung;
            noidung = ReadText(temp1[i+1]);
            txtNoiDung.setText(noidung);
        }
}//GEN-LAST:event_tbMailListMouseClicked
 public int GetMailSv()
    {
            int k =0;
            String sentMessage = "";
            String receivedMessage = "";

            try {
            Socket s = new Socket(Login.SvAd, 110);
            InputStream is = s.getInputStream();
            BufferedReader br = new BufferedReader(new InputStreamReader(s.getInputStream(), "UTF8"));
            BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(s.getOutputStream(),"UTF8"));

            String us = Login.NormalUser;
            String pw = Login.NormalPass;

            receivedMessage=br.readLine();

            sentMessage="user "+us+"";
            bw.write(sentMessage);
            bw.newLine();
            bw.flush();
            receivedMessage=br.readLine();

            sentMessage="";
            sentMessage="pass "+pw+"";
            bw.write(sentMessage);
            bw.newLine();
            bw.flush();
            receivedMessage=br.readLine();

            String []ST= receivedMessage.split(" ");
            k = Integer.parseInt(ST[4]);

            sentMessage="Quit";
            bw.write(sentMessage);
            bw.newLine();
            bw.flush();

            br.close();
            bw.close();
            s.close();


        }
            catch (IOException e)
            {JOptionPane.showMessageDialog(new JFrame(), "Lỗi nhận thư ", "Lỗi sai thông tin Mail server", JOptionPane.ERROR_MESSAGE);
               e.printStackTrace();
               System.out.println("Lỗi sai thông tin Mail server : " + e.getMessage());
        }
                // note cho nay
             return k;
    }
    private void formWindowActivated(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowActivated
        try {
            // TODO add your handling code here:
             int MailSV = GetMailSv();
             txtSoThuSV.setText("Tổng số thư trên Server là : "+MailSV+" thư");


            LoadMail();
        } catch (FileNotFoundException ex) {
            Logger.getLogger(MailList.class.getName()).log(Level.SEVERE, null, ex);
        } catch (UnsupportedEncodingException ex) {
            Logger.getLogger(MailList.class.getName()).log(Level.SEVERE, null, ex);
        } catch (IOException ex) {
            Logger.getLogger(MailList.class.getName()).log(Level.SEVERE, null, ex);
        }
        try {
            LoadOldMail();
        } catch (FileNotFoundException ex) {
            Logger.getLogger(MailList.class.getName()).log(Level.SEVERE, null, ex);
        } catch (UnsupportedEncodingException ex) {
            Logger.getLogger(MailList.class.getName()).log(Level.SEVERE, null, ex);
        } catch (IOException ex) {
            Logger.getLogger(MailList.class.getName()).log(Level.SEVERE, null, ex);
        }
    }//GEN-LAST:event_formWindowActivated
        
 public String ReadText(String str)
    {
        BufferedReader rd;
        try
        {
             rd = new BufferedReader(new InputStreamReader(new FileInputStream(str),"UTF-8"));
             String str2 = rd.readLine();
             str = "";
             while(!str2.equals("--HetThuRoi--"))
             {
                 str=str+"\r\n"+str2;
                 str2=rd.readLine();
             }

             rd.close();

        }
        catch (IOException e)
            {JOptionPane.showMessageDialog(new JFrame(), "Lỗi ", "Lỗi đọc filr", JOptionPane.ERROR_MESSAGE);
               e.printStackTrace();
               System.out.println("Lỗi đọc file : " + e.getMessage());
        }
        return str;
    }

    private void tbOldMailMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tbOldMailMouseClicked
        // TODO add your handling code here:
        String temp ="";
            try
            {
                BufferedReader rd;
                rd = new BufferedReader(new InputStreamReader(new FileInputStream(Login.NormalUser+"TempOldMail.txt"),"UTF-8"));
                int oldMailNumber = Integer.parseInt(rd.readLine().toString());
                rd.close();

                int y =0;

                while(y<oldMailNumber)
                {
                    String str = Login.NormalUser+"OldMail"+y+".txt";
                    File f = new File(str);
                    if(f.exists())
                        temp = temp +" "+ str;
                    y++;
                }

                int i = tbOldMail.getSelectedRow();
                String []temp1= temp.split(" ");
                if(i<temp1.length)
                {
                    
                    String noidung;
                    noidung = ReadText(temp1[i+1]);
                    txtNoiDung.setText(noidung);
                }

            }
            catch (IOException e)
                {
            }

        
    }//GEN-LAST:event_tbOldMailMouseClicked

    private void jToggleButton1MouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jToggleButton1MouseClicked
        // TODO add your handling code here:
        this.setVisible(false);
        new DeleteMail().setVisible(true);
    }//GEN-LAST:event_jToggleButton1MouseClicked

    private void jToggleButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jToggleButton1ActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_jToggleButton1ActionPerformed

    /**
    * @param args the command line arguments
    */
      public void LoadMail() throws FileNotFoundException, UnsupportedEncodingException, IOException
    {
        int i =0;
        int k =0;

        while (i<ReceiveMail.nMail)
        {
             BufferedReader rd;
             String fileName = Login.NormalUser+"Thu"+i+".txt";

             File f = new File(fileName);
             //Kiem tra file ... neu file ton tai thi moi đọc lên
              if (f.exists())
             {

                 rd = new BufferedReader(new InputStreamReader(new FileInputStream(Login.NormalUser+"Thu"+i+".txt"),"UTF-8"));
                
                 for(int e =0; e<4; e++)
                 {
                     String []temp = rd.readLine().split(" ");

                     if(temp[0].equals("Date:"))
                     {
                         String str="";
                         for(int h=1;h<temp.length;h++)
                             str=str+" "+temp[h];
                         tbMailList.setValueAt(str, k, 2);
                     }

                     if(temp[0].equals("From:"))
                     {
                         String str="";
                         for(int h=1;h<temp.length;h++)
                             str=str+" "+temp[h];
                         tbMailList.setValueAt(str, k, 0);
                     }

                     if(temp[0].equals("Subject:"))
                     {
                          String str="";
                         for(int h=1;h<temp.length;h++)
                             str=str+" "+temp[h];
                         tbMailList.setValueAt(str, k, 1);
                     }
                 }
                 
                 k++;
                 rd.close();
             }
             i++;
        }
    }
      public void LoadOldMail() throws FileNotFoundException, UnsupportedEncodingException, IOException
    {
        int i =0;
        int k =0;
        int oldMailNumber = 0;

        String filetempOldMail = Login.NormalUser+"TempOldMail.txt";
        File fi = new File(filetempOldMail);

        if(fi.exists())
        {
            BufferedReader rd;
            rd = new BufferedReader(new InputStreamReader(new FileInputStream(Login.NormalUser+"TempOldMail.txt"),"UTF-8"));
            oldMailNumber = oldMailNumber + Integer.parseInt(rd.readLine().toString());
            rd.close();
        }

        while (i<oldMailNumber)
        {
             BufferedReader rd;
             String fileName = Login.NormalUser+"OldMail"+i+".txt";

             File f = new File(fileName);
             //Kiem tra file ... neu file ton tai thi moi đọc lên
              if (f.exists())
             {

                 rd = new BufferedReader(new InputStreamReader(new FileInputStream(fileName),"UTF-8"));

                 for(int e =0; e<4; e++)
                 {
                     String []temp = rd.readLine().split(" ");

                     if(temp[0].equals("Date:"))
                     {
                         String str="";
                         for(int h=1;h<temp.length;h++)
                             str=str+" "+temp[h];
                         tbOldMail.setValueAt(str, k, 2);
                     }

                     if(temp[0].equals("From:"))
                     {
                         String str="";
                         for(int h=1;h<temp.length;h++)
                             str=str+" "+temp[h];
                         tbOldMail.setValueAt(str, k, 0);
                     }

                     if(temp[0].equals("Subject:"))
                     {
                          String str="";
                         for(int h=1;h<temp.length;h++)
                             str=str+" "+temp[h];
                         tbOldMail.setValueAt(str, k, 1);
                     }
                 }
                 k++;
                 rd.close();
             }
             i++;
        }
    }
   
    public static void main(String args[]) {
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                new MailList().setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JToggleButton jToggleButton1;
    private javax.swing.JTable tbMailList;
    private javax.swing.JTable tbOldMail;
    private javax.swing.JTextArea txtNoiDung;
    private javax.swing.JLabel txtSoThuSV;
    // End of variables declaration//GEN-END:variables

}
